<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>[Golang] 使用dep - Mryqu's Notes</title><meta name=keywords content="mryqu,yandongqu,博客,程序员,架构师,笔记,技术,分享"><meta property="og:title" content="[Golang] 使用dep"><meta property="og:site_name" content="Mryqu's Notes"><meta property="og:image" content="/img/author.jpg"><meta name=title content="[Golang] 使用dep - Mryqu's Notes"><meta name=description content="mryqu | yandongqu | 博客 | 软件 | 架构 | 技术"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href="/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet type=text/css><link href="/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel=stylesheet type=text/css><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css><script type=text/javascript id=hexo.configuration>var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0}</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class="site-meta custom-logo"><div class=custom-logo-site-title><a href=https://mryqu.github.io/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>Mryqu's Notes</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle></p></div><div class=site-nav-toggle><button>
<span class=btn-bar></span>
<span class=btn-bar></span>
<span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span>
<input type=text id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://mryqu.github.io/post/golang_%E4%BD%BF%E7%94%A8dep/ itemprop=url>[Golang] 使用dep</a></h1><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2017-10-22">2017-10-22</time></span>
<span class=post-category>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=/categories/golang itemprop=url rel=index><span itemprop=name>Golang</span></a>
&nbsp;</span></span>
<span>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-visitors-count>702 字 ~4分钟</span></span></div></header><div class=post-body itemprop=articleBody><p>之前的博文<a href=/post/golang_win10%E4%B8%8Bglide%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8>[Golang]Win10下Glide的安装和使用</a>记录了对Glide的学习，本博将记录对Golang包管理工具dep的学习使用。</p><h2 id=dep介绍>dep介绍</h2><p>在2012年，go get成为获取依赖包的方式。dep的FAQ中有一段描述dep是否要取代go get的解答，一句话概括就是：依赖管理工具是为应用管理代码的，go get是为GOPATH管理代码的。go get仅仅支持获取master branch上的latest代码，没有指定version、branch或revision的能力。这不符合gopher对自己项目所依赖的第三方包受控的期望。
在2015年，Russ Cox在Go 1.5发布前期以一个experiment feature身份紧急加入vendor机制，vendor标准化了项目依赖的第三方库的存放位置，隔离不同项目依赖的同一个包的不同版本。
Golang的包管理一直没有官方统一的解决方案，因此也产生了很多非官方的包管理工具。这些工具很多都很不错，但是相互兼容性差。随着Go语言在全球范围内应用的愈加广泛，缺少官方包管理工具这一问题变得日益突出。2016年GopherCon大会后，由微服务框架go-kit作者Peter Bourgon牵头， 在Go官方的组织下，Go包管理委员会经过各种头脑风暴和讨论后发布了“<a href=https://docs.google.com/document/d/18tNd8r5DV0yluCR7tPvkMTsWD_lYcRO7NhpNSDymRr8>包管理建议书</a>”，并启动了最有可能被接纳为官方包管理工具的项目dep的设计和开发。当前主导dep开发的是Sam Boyer，Sam也是dep底层包依赖分析引擎-gps的作者。2017年年初，dep项目正式对外开放。</p><h2 id=安装>安装</h2><p>我的实验平台是Win10，所以无法通过brew或者shell脚本安装，只能通过go get安装：</p><pre tabindex=0><code>go get -u github.com/golang/dep/cmd/dep
</code></pre><p>安装完，执行dep命令，出现帮助代表安装成功。</p><pre tabindex=0><code>$ dep
Dep is a tool for managing dependencies for Go projects

Usage: &#34;dep [command]&#34;

Commands:

  init     Set up a new Go project, or migrate an existing one
  status   Report the status of the project&#39;s dependencies
  ensure   Ensure a dependency is safely vendored in the project
  prune    Pruning is now performed automatically by dep ensure.
  version  Show the dep version information

Examples:
  dep init                               set up a new project
  dep ensure                             install the project&#39;s dependencies
  dep ensure -update                     update the locked versions of all dependencies
  dep ensure -add github.com/pkg/errors  add a dependency to the project

Use &#34;dep help [command]&#34; for more information about a command.

$ dep help ensure
Usage: dep ensure [-update | -add] [-no-vendor | -vendor-only] [-dry-run] [-v] [...]

Project spec:

  [:alt source URL][@]

Ensure gets a project into a complete, reproducible, and likely compilable state:

  * All non-stdlib imports are fulfilled
  * All rules in Gopkg.toml are respected
  * Gopkg.lock records precise versions for all dependencies
  * vendor/ is populated according to Gopkg.lock

Ensure has fast techniques to determine that some of these steps may be
unnecessary. If that determination is made, ensure may skip some steps. Flags
may be passed to bypass these checks; -vendor-only will allow an out-of-date
Gopkg.lock to populate vendor/, and -no-vendor will update Gopkg.lock (if
needed), but never touch vendor/.

The effect of passing project spec arguments varies slightly depending on the
combination of flags that are passed.

Examples:

  dep ensure                                 Populate vendor from existing Gopkg.toml and Gopkg.lock
  dep ensure -add github.com/pkg/foo         Introduce a named dependency at its newest version
  dep ensure -add github.com/pkg/foo@^1.0.1  Introduce a named dependency with a particular constraint

For more detailed usage examples, see dep ensure -examples.

Flags:

  -add          add new dependencies, or populate Gopkg.toml with constraints for existing dependencies (default: false)
  -dry-run      only report the changes that would be made (default: false)
  -examples     print detailed usage examples (default: false)
  -no-vendor    update Gopkg.lock (if needed), but do not update vendor/ (default: false)
  -update       update the named dependencies (or all, if none are named) in Gopkg.lock to the latest allowed by Gopkg.toml (default: false)
  -v            enable verbose logging (default: false)
  -vendor-only  populate vendor/ from Gopkg.lock without updating it first (default: false)
</code></pre><h2 id=使用>使用</h2><h3 id=maingo>main.go</h3><p>仍然使用博文<a href=/post/golang_win10%E4%B8%8Bglide%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8>[Golang]Win10下Glide的安装和使用</a>中的源码示例：</p><pre tabindex=0><code>package main

import (
  &#34;fmt&#34;
  &#34;github.com/pborman/uuid&#34;
);

func main() {
        id := uuid.New();
        fmt.Println(&#34;Hello uuid:&#34;+id);
}
</code></pre><h3 id=初始化>初始化</h3><p>通过dep init命令创建新项目（使用了-v选项打印更多细节）：</p><pre tabindex=0><code>$ dep init -v
Getting direct dependencies...
Checked 5 directories for packages.
Found 1 direct dependencies.
Root project is &#34;hellodep&#34;
 1 transitively valid internal packages
 1 external packages imported from 1 projects
(0)   ? select (root)
(1)     ? attempt github.com/pborman/uuid with 1 pkgs; 5 versions to try
(1)         try github.com/pborman/uuid@v1.1
(1)     ? select github.com/pborman/uuid@v1.1 w/1 pkgs
  ? found solution with 1 packages from 1 projects

Solver wall times by segment:
         b-list-pkgs: 5.0792684s
              b-gmal: 5.0078158s
     b-source-exists: 2.1603804s
     b-list-versions: 1.4574079s
         select-atom:         0s
               other:         0s
         select-root:         0s
  b-deduce-proj-root:         0s
             satisfy:         0s
            new-atom:         0s

  TOTAL: 13.7048725s

  Using ^1.1.0 as constraint for direct dep github.com/pborman/uuid
  Locking in v1.1 (e790cca) for direct dep github.com/pborman/uuid
(1/1) Wrote github.com/pborman/uuid@v1.1
</code></pre><p>dep init大致会做这么几件事：</p><ul><li>利用gps分析当前代码包中的包依赖关系；</li><li>将分析出的项目包的直接依赖(即main.go显式import的第三方包，direct dependency)约束(constraint)写入项目根目录下的Gopkg.toml文件中；</li><li>将项目依赖的所有第三方包（包括直接依赖和传递依赖transitive dependency）在满足Gopkg.toml中约束范围内的最新version/branch/revision信息写入Gopkg.lock文件中；</li><li>创建root vendor目录，并且以Gopkg.lock为输入，将其中的包（精确checkout 到revision）下载到项目root vendor下面。
执行完dep init后，dep会在当前目录下生成若干文件：</li></ul><pre tabindex=0><code>├── Gopkg.lock
├── Gopkg.toml
├── main.go
└── vendor/
       └── github.com/
              └── pborman/
                     └── uuid/
</code></pre><p>Gopkg.toml：记录了一个直接依赖uuid，确定的uuid依赖版本约束为1.1.0</p><pre tabindex=0><code>[[constraint]]
  name = &#34;github.com/pborman/uuid&#34;
  version = &#34;1.1.0&#34;

[prune]
  go-tests = true
  unused-packages = true
</code></pre><p>Gopkg.lock：记录了在上述约束下所有依赖可用的最新版本</p><pre tabindex=0><code>[[projects]]
  name = &#34;github.com/pborman/uuid&#34;
  packages = [&#34;.&#34;]
  revision = &#34;e790cca94e6cc75c7064b1332e63811d4aae1a53&#34;
  version = &#34;v1.1&#34;

[solve-meta]
  analyzer-name = &#34;dep&#34;
  analyzer-version = 1
  inputs-digest = &#34;fbe0d2bde8a8c1659d0e965328bda4e05f246c471267358b9dfe9c95fd1025ff&#34;
  solver-name = &#34;gps-cdcl&#34;
  solver-version = 1
</code></pre><p>至此，dep init完毕，相关依赖包也已经被vendor，可以使用go build/install进行程序构建了。
如果你对dep自动分析出来的各种约束和依赖的版本没有异议，那么这里就可以将Gopkg.toml和Gopkg.lock作为项目源码的一部分提交到代码库中了。这样其他人在下载了你的代码后，可以通过dep直接下载lock文件中的第三方包版本，并存在vendor里。这样就使得无论在何处，项目构建的依赖库理论上都是一致的，实现可重现构建。但一般不推荐将vendor目录提交到代码仓库，vendor的提交会让代码库变得异常庞大，且更新vendor时大量的diff会影响到成员对代码的review（注：对于Git代码仓库可通过.gitignore过滤掉）。</p><h3 id=构建>构建</h3><p>这里构建是通过Makefile进行，由于其他成员将项目从代码仓库克隆到本地后并没有vendor目录，所以在setup规则里使用dep ensure -vendor-only命令通过Gopkg.lock和Gopkg.toml中的数据创建vendor目录和同步里面的包，之后就可以完成可重现构建了。</p><pre tabindex=0><code>BUILD_ENV := CGO_ENABLED=0
LDFLAGS=-ldflags &#34;-w -s&#34;

TARGET_EXEC := hellodep

.PHONY: all clean setup generate build-linux build-osx build-windows

all: clean setup generate build-linux build-osx build-windows

clean:
        rm -rf build

setup:
        mkdir -p build/linux
        mkdir -p build/osx
        mkdir -p build/windows
        - ${BUILD_ENV} dep ensure -vendor-only

build-linux: setup
        ${BUILD_ENV} GOARCH=amd64 GOOS=linux go build ${LDFLAGS} -o build/linux/${TARGET_EXEC}

build-osx: setup
        ${BUILD_ENV} GOARCH=amd64 GOOS=darwin go build ${LDFLAGS} -o build/osx/${TARGET_EXEC}

build-windows: setup
        ${BUILD_ENV} GOARCH=amd64 GOOS=windows go build ${LDFLAGS} -o build/windows/${TARGET_EXEC}.exe
</code></pre><p>dep ensure命令的一些选项如下：</p><ul><li>-no-vendor选项允新Gopkg.lock，但不更新vendor目录</li><li>-vendor-only选项允许使用过时的Gopkg.lock创建vendor目录</li><li>-update选项更新Gopkg.lock中的命名依赖到Gopkg.toml允许的最高版本</li></ul><h3 id=指定依赖>指定依赖</h3><p>如果依赖包相对Gopkg.lock增加了多个版本，而项目组想要使用较新的功能时，可能会尝试用dep ensure -update命令获取最新的依赖包。
一旦发现使用最新的依赖包有问题怎么办？可以通过在Gopkg.toml指定依赖版本使用较新的可用依赖包。</p><h3 id=dep本地缓存>dep本地缓存</h3><p>dep会在$GOPATH/pkg/dep/sources下留了一块“自留地”，用于缓存所有从network上下载的依赖包。
对dep init命令使用-gopath选项会优选从$GOPATH查找依赖包。</p><h2 id=参考>参考</h2><hr><p><a href=https://github.com/golang/dep>GitHub：golang/dep</a><br><a href=https://github.com/golang/dep/blob/master/docs/FAQ.md>dep FAQ</a><br><a href=https://github.com/golang/dep/wiki/Roadmap>dep roadmap</a><br><a href=https://golang.github.io/dep/docs/Gopkg.toml.html>Gopkg.toml</a><br><a href=https://golang.github.io/dep/docs/Gopkg.lock.html>Gopkg.lock</a><br><a href=https://go-talks.appspot.com/github.com/edmontongo/presentations/2017-05/dep/dep.slide>dep - Go dependency management</a><br><a href=https://studygolang.com/articles/10008>初窥dep</a><br><a href=https://studygolang.com/articles/10589>Golang官方依赖管理工具：dep</a><br><a href=https://studygolang.com/articles/9435>Go最新的dep详解</a></p></div><footer class=post-footer><div class=post-nav><div style="border:1px dashed #e0e0e0;padding:10px;background-color:#fffeee;background-repeat:no-repeat;background-attachment:scroll;background-position:1%;-moz-background-size:auto auto;-moz-background-clip:-moz-initial;-moz-background-origin:-moz-initial;-moz-background-inline-policy:-moz-initial"><div><p style=margin-top:0>标题：[Golang] 使用dep<br>作者：<a target=_blank href=/>mryqu</a><br>声明： 本博客所有文章除特别声明外，均采用 <a href=http://creativecommons.org/licenses/by-nc-sa/3.0/cn/>CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div></div><div class=clear></div></div><div class=post-tags><a href=/tags/golang rel=tag title=golang>#golang#</a>
<a href=/tags/dep rel=tag title=dep>#dep#</a>
<a href=/tags/package rel=tag title=package>#package#</a>
<a href=/tags/dependency rel=tag title=dependency>#dependency#</a>
<a href=/tags/management rel=tag title=management>#management#</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://mryqu.github.io/post/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%8Btoml/ rel=next title=学习一下TOML><i class="fa fa-chevron-left"></i> 学习一下TOML</a></div><div class="post-nav-prev post-nav-item"><a href=https://mryqu.github.io/post/golang_go%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96/ rel=prev title="[Golang] Go项目的国际化 ">[Golang] Go项目的国际化 <i class="fa fa-chevron-right"></i></a></div></div><div class=comments id=comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://mryqu.github.io/post/golang_%E4%BD%BF%E7%94%A8dep/",this.page.identifier="https://mryqu.github.io/post/golang_%E4%BD%BF%E7%94%A8dep/"};(function(){var e=document,t=e.createElement("script");t.src="//mryqu.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/author.jpg alt><p class=site-author-name itemprop=name></p><p class="site-description motion-element" itemprop=description>Programmer & Architect</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>694</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>32</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>1503</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/mryqu target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://twitter.com/yandongqu target=_blank title=Twitter><i class="fa fa-fw fa-twitter"></i>
Twitter</a></span>
<span class=links-of-author-item><a href=https://www.facebook.com/yandongqu target=_blank title="FB Page"><i class="fa fa-fw fa-facebook"></i>
FB Page</a></span></div><div class="links-of-blogroll motion-element inline"><script type=text/javascript src="//rf.revolvermaps.com/0/0/8.js?i=01h16xrlw6m&m=0&s=220&c=ff0000&cr1=ffffff&f=arial&l=33&bv=35" async></script></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#dep介绍>dep介绍</a></li><li><a href=#安装>安装</a></li><li><a href=#使用>使用</a><ul><li><a href=#maingo>main.go</a></li><li><a href=#初始化>初始化</a></li><li><a href=#构建>构建</a></li><li><a href=#指定依赖>指定依赖</a></li><li><a href=#dep本地缓存>dep本地缓存</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span itemprop=copyrightYear>&copy;
2009 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>Mryqu's Notes</span></div><div class=powered-by>Powered by - <a class=theme-link href=http://gohugo.io target=_blank title=hugo>Hugo v0.105.0</a></div><div class=theme-info>Theme by - <a class=theme-link href=https://github.com/xtfly/hugo-theme-next target=_blank>NexT</a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript>Object.prototype.toString.call(window.Promise)!=="[object Function]"&&(window.Promise=null)</script><script type=text/javascript src="/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type=text/javascript src="/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
<script type=text/javascript src="/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type=text/javascript src="/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type=text/javascript src="/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
<script src="/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<script type=text/javascript src=/js/utils.js></script>
<script type=text/javascript src=/js/motion.js></script>
<script type=text/javascript src=/js/affix.js></script>
<script type=text/javascript src=/js/schemes/pisces.js></script>
<script type=text/javascript src=/js/scrollspy.js></script>
<script type=text/javascript src=/js/post-details.js></script>
<script type=text/javascript src=/js/toc.js></script>
<script type=text/javascript src=/js/bootstrap.js></script>
<script type=text/javascript src=/js/search.js></script>
<script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script><script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script></body></html>